# pfctl_off

## Назначение
Сценарий `/etc/context.d/pfctl_off` предназначен для периодического отключения pfSense-фильтра (`pfctl -d`), когда основной контекст выставляет `PFCTL=off`. Используется в паре с cron-заданием, чтобы гарантировать отключение даже при повторном включении pf системой.

## Схема запуска
1. Скрипт выполняется из cron/periodic (пример задания: каждую минуту).
2. Проверяет наличие файла `/var/run/pfctlcontext.pid`, который создаёт `ContextOnly` при необходимости контроля pf.
3. До шести раз с интервалом 10 секунд опрашивает `pfctl -s info`.
4. Если статус `Enabled`, вызывает `pfctl -d` и пишет запись в лог.

## Переменные контекста
Прямых переменных контекста не использует. Активация происходит, если `ContextOnly` обработал `PFCTL=off` и создал `pfctlcontext.pid`.

## Пример лога
По умолчанию вывод подавлен (`LOG=/dev/null`). При переключении на `/tmp/context.log` можно получить:
```
Wed Oct  8 19:12:00 +05 2025 [cron-context] disabled pfctl
```

## Порядок установки и проверки
1. Скопируйте файл в `/etc/context.d/pfctl_off` и сделайте исполняемым.
2. Добавьте cron-задание, например через `System > Advanced > Cron`:
   ```
   */1 * * * * root /etc/context.d/pfctl_off
   ```
3. Примените контекст с `PFCTL=off` и убедитесь, что создан `/var/run/pfctlcontext.pid`.
4. Проверьте `pfctl -s info` — статус должен стать `Disabled` после следующего запуска cron.
