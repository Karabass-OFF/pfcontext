# ResizeZfs

## Назначение
Автоматически расширяет ZFS-пул `pfSense`, если на диске появились свободные сектора (например, после роста виртуального диска в OpenNebula). Скрипт восстанавливает таблицу разделов GPT при необходимости и выполняет `gpart resize` + `zpool online -e`.

## Схема запуска
1. Запускается службой `resizezfs` (`/etc/rc.d/ResizeZfs`), когда включен параметр `resizezfs_enable="YES"`.
2. Определяет диск с пулом (`gpart show | awk '/GPT/ {print $4; exit}'`).
3. Проверяет наличие повреждений GPT (`gpart show ... | grep CORRUPT`) и выполняет `gpart recover`.
4. Подсчитывает свободные секторы. При объёме > 7128 расширяет раздел `freebsd-zfs` и онлайн-пул.
5. Выводит итоговый список пулов `zpool list pfSense`.

## Переменные контекста
Сценарий не использует переменные контекста. Поведение определяется только текущим состоянием диска.

## Примеры логов
По умолчанию лог отключён (`LOG="/dev/null"`). Для отладки смените строку на `LOG="/tmp/context.log"`. Пример вывода:
```
Wed Oct  8 19:10:00 +05 2025 [context] === START ResizeZfs Wed Oct  8 19:10:00 +05 2025 ===
Wed Oct  8 19:10:00 +05 2025 [context] Обнаружена поврежденная таблица разделов, выполняется восстановление...
Wed Oct  8 19:10:02 +05 2025 [context] ZFS-раздел расширен
```
После успешного выполнения `zpool list pfSense` покажет увеличенный объём.

## Порядок установки и проверки
1. Скопируйте файл в `/etc/context.d/ResizeZfs` и сделайте исполняемым.
2. Включите сервис в `/etc/rc.conf.local`:
   ```sh
   echo 'resizezfs_enable="YES"' >> /etc/rc.conf.local
   ```
3. Запустите вручную: `service ResizeZfs onestart`.
4. Проверьте результат: `zpool list pfSense` и, при включённом логе, `/tmp/context.log`.
