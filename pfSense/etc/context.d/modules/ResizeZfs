#!/bin/sh
# ResizeFs — universal disk resize tool for pfSense (UFS/ZFS)
# Now correctly detects the last freebsd-* partition (the root)

LOG="/var/log/context.log"
{
  echo "$(date) [context] === START ResizeFs  ==="

  DISK=$(gpart show | awk '/GPT/ {print $4; exit}')
  [ -z "$DISK" ] && { echo "$(date) [context] Failed to determine the disk — exiting"; exit 1; }

  # Определяем тип раздела (берём последний freebsd-* — корневой)
  FS_TYPE=$(gpart show "$DISK" | awk '/freebsd-/ {last=$4} END{print last}')

  case "$FS_TYPE" in
    freebsd-zfs|zfs)
      echo "$(date) [context] Detected filesystem: ZFS"
      ZFS_PART_NUM=$(gpart show "$DISK" | awk '/freebsd-zfs/ {n=$3} END{print n}')
      [ -z "$ZFS_PART_NUM" ] && { echo "$(date) [context] ZFS partition not found — exiting"; exit 0; }

      POOL=$(zpool list -H -o name 2>/dev/null | head -n1)
      [ -z "$POOL" ] && { echo "$(date) [context] ZFS pool not found — exiting"; exit 0; }

      ZFS_DEV="${DISK}p${ZFS_PART_NUM}"

      echo "$(date) [context] Expanding ZFS pool $POOL on the device $ZFS_DEV"
      gpart recover "$DISK" >/dev/null 2>&1
      gpart resize -i "$ZFS_PART_NUM" "$DISK" >/dev/null 2>&1
      zpool online -e "$POOL" "$ZFS_DEV" >/dev/null 2>&1
      zpool list "$POOL"
      echo "$(date) [context] ZFS-пул $POOL successfully expanded"
      ;;

    freebsd-ufs|ufs)
      echo "$(date) [context] Detected filesystem: UFS"
      UFS_PART_NUM=$(gpart show "$DISK" | awk '/freebsd-ufs/ {n=$3} END{print n}')
      [ -z "$UFS_PART_NUM" ] && { echo "$(date) [context] UFS partition not found — exiting"; exit 0; }

      UFS_DEV="${DISK}p${UFS_PART_NUM}"

      echo "$(date) [context] Expanding UFS partition $UFS_DEV"
      gpart recover "$DISK" >/dev/null 2>&1
      gpart resize -i "$UFS_PART_NUM" "$DISK" >/dev/null 2>&1
      growfs -y "/dev/$UFS_DEV" >/dev/null 2>&1
      echo "$(date) [context] UFS partition $UFS_DEV successfully expanded"
      ;;

    *)
      echo "$(date) [context] Unknown filesystem ($FS_TYPE) — skipping ResizeFs"
      ;;
  esac

  echo "$(date) [context] === END ResizeFs $(date) ==="

} >> "$LOG" 2>&1
