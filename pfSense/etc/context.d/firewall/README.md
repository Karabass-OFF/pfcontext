# Модуль контекстного фаервола

Этот модуль автоматизирует пошаговое (инкрементальное) управление pfSense при
подготовке виртуальной машины через контекст OpenNebula. Точка входа
`firewall.sh` запускается после конфигурации сетевых интерфейсов, считывает
переменные из `context.sh`, сравнивает их с состоянием из
`/var/run/context-firewall.state` и вносит только необходимые изменения в
выделенный anchor pf.

## Возможности

* **Идемпотентность** — модуль запоминает ранее применённые значения и
  повторно применяет только изменившиеся правила.
* **Безопасное применение** — каждый блок проверяется командой `pfctl -nf`; при
  ошибках соответствующие правила пропускаются и фиксируются в журнале.
* **Изолированный anchor** — правила загружаются в собственный anchor, чтобы не
  затронуть конфигурацию GUI и системных служб pfSense.
* **Подробное логирование** — события `apply`, `update`, `remove`, `error`
  записываются в `/var/log/context-firewall.log` для аудита и диагностики.

## Поддерживаемые переменные контекста

| Переменная | Назначение |
| --- | --- |
| `FIREWALL_ENABLE` | Включение или отключение модуля. |
| `FIREWALL_PFCTL` | Управление применением правил без отключения парсинга. |
| `FIREWALL_NAT_OUT_IF` | Интерфейс исходящего NAT. |
| `FIREWALL_FORWARD_ALLOW` | Список внутренних интерфейсов (через запятую),
  между которыми разрешён трафик. |
| `FIREWALL_NAT_NETS` | Сети (через пробел) с правом на исходящий NAT. |
| `FIREWALL_NAT_HOSTS` | Отдельные хосты (через пробел) с правом на NAT. |
| `FIREWALL_NAT_ALLOW_NETS` | Группа (alias) разрешённых для NAT сетей. |
| `FIREWALL_BLOCK_NETS` | Группа (alias) блокируемых сетей. |
| `FIREWALL_DEFAULT_FORWARD` | Политика LAN-to-LAN (`allow` или `deny`). |
| `FIREWALL_LOG` | Переключатель ведения журнала
  `/var/log/context-firewall.log`. |
| `FIREWALL_RELOAD` | Режим применения: `auto` — загрузить сразу, `manual` —
  ждать ручного запуска. |
| `FIREWALL_PORT_FORWARD_LIST` | DNAT-правила формата
  `<if>:<proto>:<ext_port>:<int_ip>:<int_port>` через пробел. |

## Сценарий выполнения

1. Загрузить вспомогательные функции (`functions.sh`) и переменные (`vars.sh`).
2. Проверить наличие необходимых утилит (`pfctl`, `php`, `pfSsh.php`).
3. Завершить работу, если модуль отключён или применение правил запрещено.
4. Сформировать alias, правила NAT, DNAT и LAN-forward на основе переменных
   контекста.
5. Проверить конфигурацию `pfctl -nf` и, если проверка успешна, применить её.
6. Обновить сохранённое состояние для последующих запусков.

## Логирование

Все ключевые действия пишутся в `/var/log/context-firewall.log`. Каждая строка
содержит метку события и краткое описание, например:

```
apply: context firewall module start (context: /mnt/context.sh)
update: refreshed outbound NAT rules for vtnet2
error: rule skipped — invalid definition "vtnet2:udp:1194:bad_ip:1194"
```

Журнал помогает отследить автоматические изменения и выявлять проблемы при
использовании контекста OpenNebula.
