# Context Firewall Module for pfSense 2.8 (OpenNebula)

`firewall.sh` ‚Äî –º–æ–¥—É–ª—å –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è **pfSense 2.8-RELEASE**, –≤—ã–ø–æ–ª–Ω—è–µ–º—ã–π –∏–∑ `ContextOnly` –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ç–µ–≤—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤.  
–°–∫—Ä–∏–ø—Ç —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ `config.xml`, —á—å–∏ –æ–ø–∏—Å–∞–Ω–∏—è –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞ `ContextFW:`;  
–≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –≤—Ä—É—á–Ω—É—é (—á–µ—Ä–µ–∑ GUI, VPN, DHCP –∏ —Ç.–¥.), –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–∫—Ä–∏–ø—Ç–∞

1. **Entry point**  
   –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (`pfctl`, `php`, `xml`, `pfSsh.php`), —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ `/var/run/context-firewall.lock` (TTL 600 —Å), –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è.

2. **Load variables**  
   –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑ `/mnt/context/context.sh` (CD-ROM OpenNebula), –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–ª–∞–≥–æ–≤ `FIREWALL_ENABLE` –∏ `FIREWALL_PFCTL`, —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–∞–±–æ—á–µ–π –∫–æ–ø–∏–∏ `config.xml` (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è backup –æ—Ç `ContextOnly`).

3. **Common functions**  
   –ñ—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ (`/var/log/context-firewall.log`), —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ (`/cf/conf/backup/config.xml.firewall.*`), –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ (`rollback`), —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (`/var/run/context-firewall.state`), –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã.

4. **NAT / Outbound NAT**  
   –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –∏—Å—Ö–æ–¥—è—â–µ–≥–æ NAT –∏ `nonat` –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö `FIREWALL_NAT_*`.

5. **DNAT / Port Forwards**  
   –ü–∞—Ä—Å–∏–Ω–≥ `FIREWALL_PORT_FORWARD_LIST`, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è DNAT-–ø—Ä–∞–≤–∏–ª –∏ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ (`assoc_rule=pass`).

6. **Forward Rules / Filters**  
   –°–æ–∑–¥–∞–Ω–∏–µ `pass` / `block` –ø—Ä–∞–≤–∏–ª –ø–æ —Å–ø–∏—Å–∫–∞–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤, IP-–∞–¥—Ä–µ—Å–æ–≤ –∏ —Å–µ—Ç–µ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.

7. **Validation & Apply**  
   –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –≤—ã–∑–æ–≤ `php /etc/rc.filter_configure_sync` –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ `/tmp/rules.debug`, –≤–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ `pfctl -nf`, –∞—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `config.xml`, –≤—ã–∑–æ–≤ `pfSsh.php playback reloadfilter` (–∏–ª–∏ –ø—Ä–æ–ø—É—Å–∫ –ø—Ä–∏ `manual`), —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è.

---

## ‚öôÔ∏è –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (`context.sh`)

–ù–∏–∂–µ –ø—Ä–∏–≤–µ–¥—ë–Ω –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –º–æ–¥—É–ª–µ–º, –∏ –∏—Ö –æ–ø–∏—Å–∞–Ω–∏–µ.  
–í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è —á–∏—Ç–∞—é—Ç—Å—è –∏–∑ `/mnt/context/context.sh` (CD-ROM OpenNebula).

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –í–æ–∑–º–æ–∂–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-------------|--------------------|-------------|
| **FIREWALL_ENABLE** | `on` / `off` | –í–∫–ª—é—á–µ–Ω–∏–µ –∏–ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª—è. |
| **FIREWALL_PFCTL** | `on` / `off` | –ü—Ä–∏–º–µ–Ω—è—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ `pfctl`. |
| **FIREWALL_RELOAD** | `auto` / `manual` | –†–µ–∂–∏–º –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è. |
| **FIREWALL_DEBUG** | `on` / `off` | –ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥. |
| **FIREWALL_LOG** | `on` / `off` | –î–æ–±–∞–≤–ª—è—Ç—å —Ñ–ª–∞–≥ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (`log`) –≤ –ø—Ä–∞–≤–∏–ª–∞. |
| **FIREWALL_DEFAULT_FORWARD** | `allow` / `deny` | –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –≤—Ö–æ–¥—è—â–µ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞. |
| **FIREWALL_NAT_OUT_IF** | –∏–º—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `wan`) | –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∏—Å—Ö–æ–¥—è—â–µ–≥–æ NAT. |
| **FIREWALL_NAT_NETS** | —Å–ø–∏—Å–æ–∫ CIDR (—á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª, –∑–∞–ø—è—Ç—É—é –∏–ª–∏ `;`) | –°–µ—Ç–∏, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö —Å–æ–∑–¥–∞—é—Ç—Å—è NAT-–ø—Ä–∞–≤–∏–ª–∞. |
| **FIREWALL_NAT_HOSTS** | —Å–ø–∏—Å–æ–∫ IP | –û—Ç–¥–µ–ª—å–Ω—ã–µ —Ö–æ—Å—Ç—ã –¥–ª—è –∏—Å—Ö–æ–¥—è—â–µ–≥–æ NAT. |
| **FIREWALL_NAT_ALLOW_NETS** | —Å–ø–∏—Å–æ–∫ CIDR | –°–µ—Ç–∏, **–∏—Å–∫–ª—é—á–∞–µ–º—ã–µ** –∏–∑ NAT (`nonat`). |
| **FIREWALL_BLOCK_NETS** | —Å–ø–∏—Å–æ–∫ CIDR | –°–µ—Ç–∏, –∫–æ—Ç–æ—Ä—ã–µ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –Ω–∞ –≤—Ö–æ–¥–µ (WAN). |
| **FIREWALL_FORWARD_ALLOW_IF** | —Å–ø–∏—Å–æ–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ | –†–∞–∑—Ä–µ—à–∏—Ç—å —Ç—Ä–∞—Ñ–∏–∫ —Å —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤. |
| **FIREWALL_FORWARD_ALLOW_IP** | —Å–ø–∏—Å–æ–∫ IP | –†–∞–∑—Ä–µ—à–∏—Ç—å —Ç—Ä–∞—Ñ–∏–∫ —Å —É–∫–∞–∑–∞–Ω–Ω—ã—Ö IP-–∞–¥—Ä–µ—Å–æ–≤. |
| **FIREWALL_PORT_FORWARD_LIST** | —Å—Ç—Ä–æ–∫–∞ —Å DNAT-–∑–∞–ø–∏—Å—è–º–∏ | –ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ–±—Ä–æ—Å–∞ –ø–æ—Ä—Ç–æ–≤ (—Å–º. –Ω–∏–∂–µ). |

---

### üîÄ –§–æ—Ä–º–∞—Ç `FIREWALL_PORT_FORWARD_LIST`

–ü—Ä–∞–≤–∏–ª–∞ —É–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `;`. –ö–∞–∂–¥–æ–µ –ø—Ä–∞–≤–∏–ª–æ ‚Äî –Ω–∞–±–æ—Ä –ø–∞—Ä `–∫–ª—é—á=–∑–Ω–∞—á–µ–Ω–∏–µ`, —Ä–∞–∑–¥–µ–ª—ë–Ω–Ω—ã—Ö –∑–∞–ø—è—Ç—ã–º–∏:

```bash
FIREWALL_PORT_FORWARD_LIST="\
if=wan,proto=tcp,ext_addr=wanaddress,ext_port=443,int_ip=192.168.10.2,int_port=443,descr=HTTPS,assoc_rule=pass;\
if=wan,proto=udp,ext_port=1194,int_ip=192.168.10.3,int_port=1194,descr=OpenVPN"

---

### –ü—Ä–∏–º–µ—Ä context.sh

```bash
# Enable context firewall
FIREWALL_ENABLE="on"
FIREWALL_PFCTL="on"
FIREWALL_RELOAD="auto"
FIREWALL_DEBUG="off"
FIREWALL_LOG="on"
FIREWALL_DEFAULT_FORWARD="deny"

# Outbound NAT
FIREWALL_NAT_OUT_IF="vtnet0"
FIREWALL_NAT_NETS="10.0.0.0/8,192.168.0.0/16"
FIREWALL_NAT_HOSTS="10.0.0.5"
FIREWALL_NAT_ALLOW_NETS="172.16.0.0/12"

# Filtering / forwarding
FIREWALL_FORWARD_ALLOW_IF="lan,opt1"
FIREWALL_FORWARD_ALLOW_IP="10.0.0.8,192.168.10.5"
FIREWALL_BLOCK_NETS="203.0.113.0/24"

### Port forwarding
FIREWALL_PORT_FORWARD_LIST="\
if=wan,proto=tcp,ext_port=443,int_ip=192.168.10.2,int_port=443,descr=HTTPS,assoc_rule=pass;\
if=wan,proto=udp,ext_port=1194,int_ip=192.168.10.3,int_port=1194,descr=OpenVPN"

###–†–µ–∂–∏–º manual
–ï—Å–ª–∏ FIREWALL_RELOAD="manual", –º–æ–¥—É–ª—å –≥–æ—Ç–æ–≤–∏—Ç –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é,
–Ω–æ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç pfSsh.php playback reloadfilter –∏ /etc/rc.reload_all.
–ï—Å–ª–∏ FIREWALL_RELOAD="manual", –º–æ–¥—É–ª—å –≥–æ—Ç–æ–≤–∏—Ç –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é,
–Ω–æ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç pfSsh.php playback reloadfilter –∏ /etc/rc.reload_all.

–ß—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –≤—Ä—É—á–Ω—É—é:

```sh
/usr/local/sbin/pfSsh.php playback reloadfilter
/etc/rc.reload_all
```
–°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (`sha256` –æ—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö) —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `/var/run/context-firewall.state`. –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫ —Å —Ç–µ–º–∏ –∂–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–≤–µ–¥–µ–Ω–∏—è
- –õ–æ–≥: `/var/log/context-firewall.log` —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞–º–∏ `[INFO]`, `[WARN]`, `[ERROR]`, `[DEBUG]`.
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞: `/var/run/context-firewall.lock` (—É–¥–∞–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, TTL 600 —Å–µ–∫—É–Ω–¥).
- –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è: `/cf/conf/backup/config.xml.firewall.<timestamp>`; –ø—Ä–∏ –æ—à–∏–±–∫–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è `[rollback]` –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ `config.xml`.
- –ú–æ–¥—É–ª—å —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∞–≤–∏–ª–∞–º–∏ `ContextFW:` –∏ –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, VPN –∏–ª–∏ DHCP.