# üìò README ‚Äì BGP Context Script –¥–ª—è pfSense (FRR) + OpenNebula

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç **BGP –≤ pfSense** —Å –ø–æ–º–æ—â—å—é **FRR** (Free Range Routing), –∏—Å–ø–æ–ª—å–∑—É—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ OpenNebula.  
–û–Ω:
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ `/conf/config.xml` —á–µ—Ä–µ–∑ PHP API pfSense.
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∂–∏–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ FRR —á–µ—Ä–µ–∑ `vtysh`.
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ).

---

## ‚öôÔ∏è –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è
1. –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–∞–∫–µ—Ç **FRR** (`frr9` –∏–ª–∏ `pfSense-pkg-frr`).
2. –î–æ—Å—Ç—É–ø–Ω–∞ –∫–æ–Ω—Å–æ–ª—å–Ω–∞—è —É—Ç–∏–ª–∏—Ç–∞ **php** (`/usr/local/bin/php`).
3. –î–æ—Å—Ç—É–ø–µ–Ω **vtysh** (`/usr/local/bin/vtysh`) –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ –∂–∏–≤–æ–π —Å–∏—Å—Ç–µ–º–µ.
4. –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è —Å–ª—É–∂–±–∞ —É–∂–µ —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–ª–∞ –¥–∏—Å–∫ –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (—Å–∫—Ä–∏–ø—Ç –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç `mount`).
   - –ü—Ä–∏ —Ä—É—á–Ω–æ–º –∑–∞–ø—É—Å–∫–µ –º–æ–∂–Ω–æ —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∏—Å–∫ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å `.` `/mnt/context/context.sh` –¥–æ –≤—ã–∑–æ–≤–∞ –º–æ–¥—É–ª—è.

---

## üìÇ –û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
–í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –∑–∞–¥–∞–Ω—ã —á–µ—Ä–µ–∑ `context.sh`.

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|------------|------------|---------|
| `BGP_ENABLE` | –í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª—è | `yes` |
| `BGP_AS` | –õ–æ–∫–∞–ª—å–Ω—ã–π ASN | `65001` |
| `BGP_ROUTER_ID` | Router ID | `192.0.2.1` |
| `BGP_NEIGHBORS` | –°–æ—Å–µ–¥–∏ BGP: `IP,ASN,Password` (—á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª/;) | `10.0.0.1,65002,secret 10.0.0.2,65003,secret` |
| `BGP_RMAP_DEFAULT` | Route-map –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é | `ALL` |
| `BGP_REDIST_CONNECTED` | Redistribute connected | `yes/no` |
| `BGP_REDIST_STATIC` | Redistribute static | `yes/no` |
| `BGP_REDIST_KERNEL` | Redistribute kernel | `yes/no` |
| `BGP_ADJACENCY_LOG` | –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Å–µ–¥—Å—Ç–≤–æ | `on/off` |
| `BGP_NETWORKS_TO_DISTRIBUTE` | –°–µ—Ç–∏ –¥–ª—è –∞–Ω–æ–Ω—Å–∞: `prefix,route-map` | `192.168.1.0/24,ALL 10.0.0.0/16,ALL` |

---

## –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ FRR –∏ PHP.
2. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–≥—Ä—É–∑–∏–ª –æ—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (`ContextOnly`).
   - –ü—Ä–∏ —Ä—É—á–Ω–æ–π –æ—Ç–ª–∞–¥–∫–µ –º–æ–∂–Ω–æ –∑–∞—Ä–∞–Ω–µ–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å `context.sh` –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–µ.
3. –°—á–∏—Ç–∞–µ—Ç **—Ö—ç—à –æ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö** (ASN, Router ID, —Å–æ—Å–µ–¥–∏, —Å–µ—Ç–∏).
   - –ï—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç ‚Üí –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ä–∞–±–æ—Ç—É.
4. –§–æ—Ä–º–∏—Ä—É–µ—Ç PHP-—Å–∫—Ä–∏–ø—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç `/conf/config.xml`.
5. –ü—Ä–∏–º–µ–Ω—è–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ **vtysh**:
   - –ü—Ä–∏ —Å–º–µ–Ω–µ ASN –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **–ø–æ–ª–Ω—ã–π reset**.
   - –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–µ—Ç–µ–π/—Å–æ—Å–µ–¥–µ–π ‚Üí –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** (diff).
6. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ `/var/run/context-bgp.*`.

---

## üìë –õ–æ–≥–∏ –∏ —Ñ–∞–π–ª—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è
- –õ–æ–≥: `/var/log/context-bgp.log` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `/dev/null`).
- –•—ç—à —Å–æ—Å—Ç–æ—è–Ω–∏—è: `/var/run/context-bgp.hash`.
- –°–ø–∏—Å–∫–∏:
  - –°–µ—Ç–∏: `/var/run/context-bgp.nets`.
  - Router ID: `/var/run/context-bgp.routerid`.
  - –°–æ—Å–µ–¥–∏: `/var/run/context-bgp.neigh`.

---

## ‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫
–°–∫—Ä–∏–ø—Ç –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é –∏–ª–∏ —á–µ—Ä–µ–∑ **context service**:

```sh
sh /usr/local/etc/context.d/bgp
