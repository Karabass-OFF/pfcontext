# pfSense Context Automation for OpenNebula

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è **–ø–µ—Ä–≤–∏—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã pfSense**, —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ–π –≤ **OpenNebula**.
–°–∫—Ä–∏–ø—Ç—ã —á–∏—Ç–∞—é—Ç —Ñ–∞–π–ª `context.sh` –∏–∑ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ CD-ROM –∏ –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:

* –æ–±–Ω–æ–≤–ª—è—é—Ç `config.xml`,
* –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç —Å–µ—Ç–µ–≤—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã,
* –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç —Å–ª—É–∂–±—ã pfSense,
* –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É—é—Ç FRR/BGP.

–≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤—ã–π –∫ —Ä–∞–±–æ—Ç–µ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä **—Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –í–ú**, –±–µ–∑ —Ä—É—á–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞.

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

| –ü—É—Ç—å                                          | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                                                                                                                                     |
| --------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `pfSense/INSTALL`                             | –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—é —Å–∫—Ä–∏–ø—Ç–æ–≤: –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ, —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ç—á–∞, —É—Å—Ç–∞–Ω–æ–≤–∫–∞ FRR, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞.                            |
| `pfSense/tmp/rc.initial.patch`                | –î–æ–±–∞–≤–ª—è–µ—Ç –≤—ã–∑–æ–≤—ã `ResizeZfs` –∏ `ContextOnly` –Ω–∞ —Ä–∞–Ω–Ω–µ–π —Å—Ç–∞–¥–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏; –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫ –≤ —Ç–µ—á–µ–Ω–∏–µ –ø–µ—Ä–≤—ã—Ö 3 –º–∏–Ω—É—Ç –∞–ø—Ç–∞–π–º–∞.                       |
| `pfSense/etc/context.d/ContextOnly`           | –û—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å. –ú–æ–Ω—Ç–∏—Ä—É–µ—Ç CD-ROM, —á–∏—Ç–∞–µ—Ç `context.sh`, –æ–±–Ω–æ–≤–ª—è–µ—Ç `config.xml`, –ø—Ä–∏–º–µ–Ω—è–µ—Ç —Å–µ—Ç–µ–≤—ã–µ –∏ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–ª—É–∂–±–∞–º–∏ –∏ –ø–∞—Ä–æ–ª–µ–º `admin`. |
| `pfSense/etc/context.d/firewall/`             | –ú–æ–¥—É–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è NAT, DNAT –∏ –º–µ–∂—Å–µ—Ç–µ–≤—ã–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏ –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞; —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç alias-–≥—Ä—É–ø–ø—ã –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ pfctl. |
| `pfSense/etc/context.d/bgp`                   | –ú–æ–¥—É–ª—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ FRR/BGP. –§–æ—Ä–º–∏—Ä—É–µ—Ç –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –≤–µ–¥—ë—Ç –ª–æ–≥ –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.              |
| `pfSense/etc/context.d/ResizeZfs`             | –†–∞—Å—à–∏—Ä—è–µ—Ç ZFS-—Ä–∞–∑–¥–µ–ª/–ø—É–ª –ø—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –¥–∏—Å–∫–∞; –≤–µ–¥—ë—Ç –∂—É—Ä–Ω–∞–ª –æ–ø–µ—Ä–∞—Ü–∏–π.                                                                             |
| `pfSense/etc/context.d/pfctl_off`             | –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ PID-—Ñ–∞–π–ª—É, –Ω—É–∂–Ω–æ –ª–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å firewall (pfctl).                                                                                          |
| `pfSense/etc/devd/context.conf`               | –ü—Ä–∞–≤–∏–ª–∞ devd –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –º–æ–¥—É–ª–µ–π –ø—Ä–∏ —Å–æ–±—ã—Ç–∏—è—Ö (CD-ROM, resize, –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã).                                                        |
| `pfSense/etc/cron.d/context`                  | –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫, –µ–∂–µ–º–∏–Ω—É—Ç–Ω–æ –≤—ã–∑—ã–≤–∞—é—â–∏–π `pfctl_off`.                                                                                                                |
| `pfSense/etc/phpshellsessions/ChangePassTool` | PHP-—Å–∫—Ä–∏–ø—Ç pfSense –¥–ª—è —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `admin`.                                                                                                      |

---

## –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –º–æ–¥—É–ª–µ–π

1. **–†–∞–Ω–Ω—è—è –∑–∞–≥—Ä—É–∑–∫–∞ pfSense**

   * –ü–∞—Ç—á `rc.initial` –∑–∞–ø—É—Å–∫–∞–µ—Ç `ResizeZfs` –∏ `ContextOnly` –æ–¥–∏–Ω —Ä–∞–∑ –≤ –ø–µ—Ä–≤—ã–µ 180 —Å–µ–∫—É–Ω–¥.
   * –§–∞–π–ª `/var/run/contextallrun_started` –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫.

2. **–ê–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (devd)**

   * `ContextOnly` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ CD-ROM.
   * `ResizeZfs` –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –¥–∏—Å–∫–∞.
   * –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–µ—Ç–µ–≤—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ `/etc/context.d/net.pid`.

3. **–ú–æ–¥—É–ª—å `ContextOnly`**

   * –ú–æ–Ω—Ç–∏—Ä—É–µ—Ç CD-ROM `/dev/cd0` ‚Üí `/mnt/context`.
   * –ß–∏—Ç–∞–µ—Ç `context.sh`, –¥–µ–ª–∞–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é `config.xml`.
   * –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã (LAN/WAN/OPT), IP/–º–∞—Å–∫–∏/—à–ª—é–∑—ã, DNS, hostname.
   * –£–ø—Ä–∞–≤–ª—è–µ—Ç `pfctl`, `RC_RELOAD_*`, –ø–∞—Ä–æ–ª–µ–º `admin`, SSH-–∫–ª—é—á–∞–º–∏.
   * –ó–∞–ø—É—Å–∫–∞–µ—Ç –º–æ–¥—É–ª—å `firewall`, –∑–∞—Ç–µ–º `bgp`, —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä—É–µ—Ç CD-ROM.

4. **–ú–æ–¥—É–ª—å `firewall`**

   * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ `context.sh` –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç alias-–≥—Ä—É–ø–ø—ã `CTX_ALLOW_NETS` –∏ `CTX_BLOCK_NETS`.
   * –û–±–Ω–æ–≤–ª—è–µ—Ç outbound NAT (—Å–µ—Ç–∏ –∏ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ö–æ—Å—Ç—ã), –ø—Ä–∞–≤–∏–ª–∞ DNAT –∏ transit (forward) –Ω–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö.
   * –í—ã–∑—ã–≤–∞–µ—Ç `filter_configure()` –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `/tmp/rules.debug` —á–µ—Ä–µ–∑ `pfctl -nf`, –∑–∞—Ç–µ–º –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ `pfctl -f`.

5. **–ú–æ–¥—É–ª—å `bgp`**

   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ FRR.
   * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç `config.xml` –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ PHP –∏ `vtysh`.
   * –•—Ä–∞–Ω–∏—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Å—É–º–º—ã –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ `/var/run/context-bgp.*`.

6. **`ResizeZfs`**

   * –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—à–∏—Ä—è–µ—Ç ZFS-—Ä–∞–∑–¥–µ–ª –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞.
   * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ, –∏ –ø—Ä–∏ —Å–æ–±—ã—Ç–∏—è—Ö devd.

7. **–ö–æ–Ω—Ç—Ä–æ–ª—å firewall**

   * `cron` –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É –≤—ã–∑—ã–≤–∞–µ—Ç `pfctl_off`.
   * –ï—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç `/var/run/pfctlcontext.pid`, `pfctl` –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è.

> üí° –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –±–µ–∑ –ø–∞—Ç—á–∞: –¥–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É
> `<earlyshellcmd>/etc/context.d/ContextOnly </earlyshellcmd>`
> –≤ `config.xml`. –û–¥–Ω–∞–∫–æ –ø–æ—Å—Ç–∞–≤–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–∞—Ç—á `rc.initial`.

---

## –ü—Ä–æ—Ü–µ—Å—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏

1. **–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤**

   ```bash
   scp -r ./ root@pfSense:/
   ```

2. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π**

   ```bash
   pkg install -y xmlstarlet pfSense-pkg-frr
   ```

   –∏–ª–∏

   ```bash
   pkg install -y xmlstarlet frr9
   ```

3. **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ç—á–∞**

   ```bash
   patch --dry-run < /tmp/rc.initial.patch
   patch < /tmp/rc.initial.patch
   ```

4. **–û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ –∏ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ).

5. **–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ pfSense**:

   ```bash
   reboot
   ```

---

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

–í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–¥–∞—é—Ç—Å—è –≤ `context.sh` (Bash-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç).
–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –æ–±–∞ –ø—Ä–µ—Ñ–∏–∫—Å–∞: `ETHx_*` –∏ `ETHERNETx_*`.

### üîπ –°–µ—Ç–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è     | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                              |
| -------------- | --------------------------------------- |
| `ETHx_MAC`     | MAC-–∞–¥—Ä–µ—Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è. |
| `ETHx_TYPE`    | –†–æ–ª—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞: `lan`, `wan`, `optN`.  |
| `ETHx_IP`      | IPv4-–∞–¥—Ä–µ—Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.                  |
| `ETHx_MASK`    | –ú–∞—Å–∫–∞ –ø–æ–¥—Å–µ—Ç–∏.                          |
| `ETHx_GATEWAY` | –®–ª—é–∑ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–¥–ª—è WAN).            |
| `ETHx_DNS`     | DNS-—Å–µ—Ä–≤–µ—Ä—ã (—á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª).             |

> –ï—Å–ª–∏ —Ç–∏–ø –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ —Å–µ—Ç–∏ –Ω–∞–∑–Ω–∞—á–∞—é—Ç—Å—è –∫–∞–∫ `lan`, –ø—É–±–ª–∏—á–Ω—ã–µ ‚Äî –∫–∞–∫ `wan`.

---

### üîπ –°–µ—Ä–≤–∏—Å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è        | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                                 |
| ----------------- | ---------------------------------------------------------- |
| `PFCTL`           | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ firewall (`off` / `on`).                        |
| `RC_RELOAD_ALL`   | –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è `config.xml`. |
| `RC_RELOAD_IFACE` | –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ WAN-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ –±–µ–∑ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏.        |
| `PASSWORD`        | –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å `admin`.                                      |
| `SSH_PUBLIC_KEY`  | –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ `/root/.ssh/authorized_keys`.                |

---

### üîπ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã BGP –∏ FRR

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è                   | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                       |
| ---------------------------- | -------------------------------- |
| `BGP_ENABLE`                 | –í–∫–ª—é—á–∞–µ—Ç –º–æ–¥—É–ª—å BGP.             |
| `BGP_AS`, `BGP_ROUTER_ID`    | –ù–æ–º–µ—Ä AS –∏ router-id.            |
| `BGP_NEIGHBORS`              | –°–æ—Å–µ–¥–∏ (IP,ASN,password).        |
| `BGP_NETWORKS_TO_DISTRIBUTE` | –°–µ—Ç–∏ –¥–ª—è –∞–Ω–æ–Ω—Å–∞ (CIDR,RouteMap). |
| `BGP_RMAP_DEFAULT`           | Route-map –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.          |
| `FRR_ENABLE`                 | –í–∫–ª—é—á–µ–Ω–∏–µ FRR.                   |
| `FRR_DEFAULT_ROUTER_ID`      | Router-id FRR.                   |

### üîπ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã firewall

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è                    | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                                                                 |
| ----------------------------- | ------------------------------------------------------------------------------------------ |
| `FIREWALL_ENABLE`             | –í–∫–ª—é—á–∞–µ—Ç –º–æ–¥—É–ª—å firewall (`on`/`off`).                                                     |
| `FIREWALL_PFCTL`              | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –ø—Ä–∞–≤–∏–ª —á–µ—Ä–µ–∑ `pfctl` (`on` ‚Äî –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å, `off` ‚Äî —Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–∞—Ç—å).|
| `FIREWALL_NAT_OUT_IF`         | –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏—Å—Ö–æ–¥—è—â–µ–≥–æ NAT.                                                                  |
| `FIREWALL_NAT_NETS`           | –°–µ—Ç–∏ (—á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª) –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ outbound NAT.                                      |
| `FIREWALL_NAT_HOSTS`          | –û—Ç–¥–µ–ª—å–Ω—ã–µ IP-–∞–¥—Ä–µ—Å–∞ –¥–ª—è NAT.                                                               |
| `FIREWALL_PORT_FORWARD_LIST`  | –°–ø–∏—Å–æ–∫ DNAT-–ø—Ä–∞–≤–∏–ª `iface:proto:ext_port:int_ip:int_port`.                                 |
| `FIREWALL_FORWARD_ALLOW`      | –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã, –º–µ–∂–¥—É –∫–æ—Ç–æ—Ä—ã–º–∏ —Ä–∞–∑—Ä–µ—à—ë–Ω —Ç—Ä–∞–Ω–∑–∏—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä `lan1,lan2`).                        |
| `FIREWALL_ALLOW_NETS`         | –°–ø–∏—Å–æ–∫ —Å–µ—Ç–µ–π –¥–ª—è alias `CTX_ALLOW_NETS`.                                                    |
| `FIREWALL_BLOCK_NETS`         | –°–ø–∏—Å–æ–∫ —Å–µ—Ç–µ–π/–∞–¥—Ä–µ—Å–æ–≤ –¥–ª—è alias `CTX_BLOCK_NETS`.                                            |
| `FIREWALL_DEFAULT_FORWARD`    | –ü–æ–ª–∏—Ç–∏–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (`allow` –∏–ª–∏ `deny`) –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤.                       |
| `FIREWALL_LOG`                | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –º–æ–¥—É–ª—è (`on`/`off`).                                                |
| `FIREWALL_RELOAD`             | `auto` ‚Äî —Å—Ä–∞–∑—É –ø—Ä–∏–º–µ–Ω—è—Ç—å —á–µ—Ä–µ–∑ `pfctl`, `manual` ‚Äî —Ç–æ–ª—å–∫–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é.          |

---

### üîπ –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è     | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                                     |
| -------------- | -------------------------------------------------------------- |
| `SET_HOSTNAME` | –ò–º—è —Ö–æ—Å—Ç–∞ pfSense.                                             |
| `CONTEXT_*`    | –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–ª—É–∂–µ–±–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–Ω–µ –∏–∑–º–µ–Ω—è—é—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º). |

---

## –ü—Ä–∏–º–µ—Ä `context.sh`

```bash
# WAN
ETH0_MAC="00:50:56:aa:bb:01"
ETH0_TYPE="wan"
ETH0_IP="203.0.113.10"
ETH0_MASK="255.255.255.252"
ETH0_GATEWAY="203.0.113.9"
ETH0_DNS="8.8.8.8 1.1.1.1"

# LAN
ETH1_MAC="00:50:56:aa:bb:02"
ETH1_TYPE="lan"
ETH1_IP="192.168.10.1"
ETH1_MASK="255.255.255.0"
ETH1_DNS="192.168.10.1"

# System
SET_HOSTNAME="pfsense-demo"
PFCTL="off"
RC_RELOAD_ALL="on"
PASSWORD="SuperSecret123"
SSH_PUBLIC_KEY="ssh-ed25519 AAAAC3Nz... user@example"

# BGP / FRR
FRR_ENABLE="on"
FRR_DEFAULT_ROUTER_ID="192.0.2.1"
BGP_ENABLE="on"
BGP_AS="65001"
BGP_ROUTER_ID="192.0.2.1"
BGP_RMAP_DEFAULT="ALL"
BGP_NETWORKS_TO_DISTRIBUTE="192.168.10.0/24,ALL"
BGP_NEIGHBORS="198.51.100.2,65002,s3cr3t"
BGP_REDIST_CONNECTED="yes"
BGP_REDIST_STATIC="no"
```

---

## –û—Ç–ª–∞–¥–∫–∞ –∏ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è

| –¶–µ–ª—å                       | –î–µ–π—Å—Ç–≤–∏–µ                                                  |
| -------------------------- | --------------------------------------------------------- |
| –û—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥               | `/var/log/context.log` ‚Äî —Å–æ–±—ã—Ç–∏—è ContextOnly.             |
| –õ–æ–≥ BGP                    | `/var/log/context-bgp.log` ‚Äî –æ–ø–µ—Ä–∞—Ü–∏–∏ FRR.                |
| –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ | `/etc/context.d/ContextOnly` –≤—Ä—É—á–Ω—É—é.                     |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–∫–µ—Ç–æ–≤           | `pkg info xmlstarlet` / `pkg info frr9`.                  |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ zpool             | `zpool list pfSense` ‚Äî —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ ResizeZfs –ø—Ä–∏–º–µ–Ω—ë–Ω. |

> –ï—Å–ª–∏ `PFCTL=off`, —É–±–µ–¥–∏—Ç–µ—Å—å –≤ –Ω–∞–ª–∏—á–∏–∏ `/var/run/pfctlcontext.pid` ‚Äî –±–µ–∑ –Ω–µ–≥–æ cron-–∑–∞–¥–∞—á–∞ –Ω–µ –≤–º–µ—à–∏–≤–∞–µ—Ç—Å—è.

---

## –ò—Ç–æ–≥

–≠—Ç–æ—Ç –Ω–∞–±–æ—Ä —Å–∫—Ä–∏–ø—Ç–æ–≤ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç **–ø–æ–ª–Ω—É—é –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ pfSense** –≤ —Å—Ä–µ–¥–µ OpenNebula:
—Å–µ—Ç–µ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞, FRR/BGP, SSH-–¥–æ—Å—Ç—É–ø, –ø–∞—Ä–æ–ª–∏ –∏ DNS ‚Äî –≤—Å—ë –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å—Ç–∞—Ä—Ç–µ.
–î–æ–∫—É–º–µ–Ω—Ç –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –∫–∞–∫ **—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤**.
