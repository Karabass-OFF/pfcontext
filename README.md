# pfcontext

## Назначение проекта
Автоматизация первичной настройки виртуальной машины pfSense, развёрнутой в OpenNebula. Скрипты читают файл `context.sh` из виртуального CD-ROM, и на основании переданных переменных обновляют `config.xml`, настраивают сетевые интерфейсы, службы pfSense и компоненты FRR/BGP. Это позволяет получить готовый к работе маршрутизатор сразу после первого запуска ВМ без ручного вмешательства.

## Структура репозитория
| Путь | Назначение |
| --- | --- |
| `pfSense/INSTALL` | Краткий чек-лист развертывания пакета контекстных скриптов на pfSense. |
| `pfSense/tmp/rc.initial.patch` | Патч для добавления запуска `ResizeZfs` и `ContextOnly` в `/etc/rc.initial`. |
| `pfSense/etc/context.d/ContextOnly` | Основной модуль: читает `context.sh`, применяет сеть, системные параметры и вызывает BGP. |
| `pfSense/etc/context.d/bgp` | Интеграция с FRR/BGP и инкрементальное обновление маршрутизации. |
| `pfSense/etc/context.d/ResizeZfs` | Расширение ZFS-раздела и пула при увеличении виртуального диска. |
| `pfSense/etc/context.d/pfctl_off` | Поддержка выключения pfctl по PID-файлу через cron. |
| `pfSense/etc/context.d/modules/mgmt.sh` | Управление выделенным MGMT-интерфейсом: алиасы, правила firewall и anti-lockout. |
| `pfSense/etc/devd/context.conf` | Триггеры `devd` для запуска контекста при событиях CD-ROM/диска/интерфейсов. |
| `pfSense/etc/cron.d/context` | Cron-задача для регулярного вызова `pfctl_off`. |
| `pfSense/etc/phpshellsessions/ChangePassTool` | Скрипт pfSense для смены пароля `admin`, используемый контекстом. |

## Последовательность выполнения и взаимосвязь модулей
1. **Загрузка pfSense и запуск ранних команд.** Патч `rc.initial` добавляет последовательный вызов `ResizeZfs` и `ContextOnly`, поэтому сценарии стартуют в штатной цепочке загрузки сразу после монтирования конфигурации.
2. **Обработка аппаратных событий.** `devd` дополнительно вызывает `ContextOnly`, когда в систему вставляется ISO `CONTEXT`, и `ResizeZfs` при изменении размера диска, а также отмечает изменения сетевых интерфейсов в `/etc/context.d/net.pid`.
3. **Основной модуль ContextOnly.**
   - Монтирует CD-ROM `/dev/cd0` в `/mnt/context`, читает `context.sh`, делает резервную копию `config.xml` и подготавливает вспомогательную функцию `get_ctx_var` для чтения `ETHx_*` переменных.
   - Анализирует требуемые интерфейсы (MAC, типы), при необходимости очищает секцию `<interfaces>` в `config.xml`, сопоставляет MAC-адреса, назначает роли LAN/WAN/OPT, прописывает IP/маску/шлюз, отключает `blockpriv/bogons` на WAN и обновляет `config.xml`.
   - Собирает DNS-адреса, задаёт hostname, по опциям `RC_RELOAD_ALL`/`RC_RELOAD_IFACE` перезапускает службы/интерфейсы, управляет состоянием pfctl через `PFCTL`, обновляет пароль `admin`, размонтирует CD-ROM и запускает модуль BGP, если он доступен.
   - При наличии `SSH_PUBLIC_KEY` кодирует ключ в Base64, записывает его в `config.xml` (секция пользователя `admin`) и добавляет в `/root/.ssh/authorized_keys`, чтобы ключ был доступен сразу после инициализации.
4. **Модуль BGP.** Запускается из `ContextOnly` и выполняет полную цепочку проверки зависимостей FRR, подгрузки `context.sh` при необходимости, генерации `config.xml` через PHP и применения настроек в рантайме через `vtysh`. Для предотвращения избыточных изменений хранит контрольные суммы и состояния сетей/соседей в `/var/run/context-bgp.*`.
5. **Модуль управления management-интерфейсом (`modules/mgmt.sh`).** Активируется, когда в `context.sh` выставлено `MGMT_ENABLE=YES`: переводит выбранный логический интерфейс `MGMT_IF` в режим управляемого доступа, отключает anti-lockout веб-интерфейса, удаляет gateway, синхронизирует алиас `MGMT_PORTS` и пересобирает набор правил `[MGMT]` (ICMP, разрешённые порты, блокирующее правило). При `MGMT_ENABLE=NO` выполняет обратные операции и возвращает конфигурацию в исходное состояние.
6. **ResizeZfs.** Может запускаться как на старте, так и при событиях `devd`; расширяет ZFS-раздел и пул `pfSense`, если обнаружено свободное место и нет повреждений GPT.
7. **Периодический контроль firewall.** `cron` каждую минуту запускает `pfctl_off`, который отключает pfctl, если существует PID-файл `/var/run/pfctlcontext.pid`. Это позволяет оставлять firewall выключенным до завершения контекстной инициализации.
Первичный запуск теперь осуществляется штатным механизмом pfSense.

## Процесс установки
1. Скопируйте содержимое каталога `pfSense` на целевую систему (например, через `scp -r ./ root@pfSense:/`).
2. Установите зависимости:
   - `xmlstarlet` (команда `pkg install -y xmlstarlet`) — предоставляет утилиту `xml`, которой оперирует `ContextOnly` для редактирования `config.xml` и чтения текущих значений.
   - `php` CLI — уже входит в pfSense, но модуль BGP проверяет наличие `/usr/local/bin/php`; убедитесь, что пакет установлен.
   - `pfSense-pkg-frr` или `frr9` — обязательны для работы BGP-модуля; устанавливаются через `pkg install` (скрипт предлагает найти актуальный пакет командой `pkg search -x frr`).
3. Добавьте ранний запуск контекста. Откройте `config.xml` и в раздел `<system>` добавьте строку `<earlyshellcmd>/etc/context.d/ResizeZfs && /etc/context.d/ContextOnly </earlyshellcmd>` либо следуйте подсказкам из `pfSense/INSTALL`.
4. При необходимости очистите логи/бэкапы (опциональный шаг из исходной инструкции).
5. Перезагрузите устройство pfSense, чтобы запустился новый поток инициализации.

## Переменные контекста
Все параметры задаются в `context.sh`, который подключается на раннем этапе загрузки. Ниже — пользовательские переменные, сгруппированные по функциям. Префиксы `ETHx_` и `ETHERNETx_` взаимозаменяемы.


### Системные/служебные 
| Переменная | Назначение |
| --- | --- |
| `SET_HOSTNAME` | Имя хоста, которое записывается в систему и `config.xml`. |
| `RC_RELOAD_ALL` / `RC_RELOAD_IFACE` | Управление перезапуском служб/интерфейсов после изменения `config.xml`. |
| `CONTEXT`-переменные среды | Внутренние переменные (`CONTEXT_MOUNT`, `CONTEXT_DEV`, `PID`) управляют процессом монтирования ISO и отслеживанием изменений интерфейсов. Пользователю их задавать не нужно, но важно знать о лог-файле `/var/log/context.log`. |

### Сеть
- `ETHx_MAC` — привязка интерфейса к MAC-адресу на хосте.
- `ETHx_TYPE` — требуемая роль (`lan`, `wan`, `optN`), определяет раздел `<interfaces>`.
- `ETHx_IP` / `ETHx_MASK` — IPv4-адрес и маска, записываемые в `config.xml`.
- `ETHx_GATEWAY` — шлюз по умолчанию для WAN-интерфейса.
- `ETHx_DNS` — список DNS-серверов, применяемых к системе и `config.xml`.
- `SET_HOSTNAME` — имя хоста pfSense.

### Диск
- Дополнительных переменных не требуется — `ResizeZfs` расширяет пул автоматически при наличии свободного места.

### Фаервол и доступ
- `PASSWORD` — новый пароль пользователя `admin` (через `ChangePassTool`).
- `SSH_PUBLIC_KEY` — публичный SSH-ключ для `admin` (base64 → `config.xml`).
- `PFCTL` — целевое состояние firewall (`on`/`off`).
- `BLOCK_PRIVATE_NETWORKS` — сохраняет фильтр `blockpriv` на WAN при `on`.
- `BLOCK_BOGON_NETWORKS` — сохраняет фильтр `blockbogons` на WAN при `on`

### Управление management-интерфейсом
- `MGMT_ENABLE` — включает (YES) или отключает (NO) применение модуля `mgmt.sh` для выбранного интерфейса.
- `MGMT_IF` — логическое имя интерфейса pfSense (`lan`, `wan`, `optN`), для которого настраиваются правила доступа и убирается шлюз.
- `MGMT_PORT` — перечень TCP-портов (через запятую), из которых формируется алиас `MGMT_PORTS` и разрешается доступ к webGUI/SSH; ICMP добавляется автоматически.

### Автоматизация перезапусков
- `RC_RELOAD_ALL` — полный перезапуск служб после применения `config.xml`.
- `RC_RELOAD_IFACE` — перезапуск WAN-интерфейсов без полного рестарта.

### BGP и FRR
- `BGP_ENABLE` — включает модуль `bgp`.
- `BGP_AS` / `BGP_ROUTER_ID` — номер AS и Router-ID (обязательны при включении).
- `BGP_NEIGHBORS` — соседи в формате `IP,ASN,password` (через пробел/`;`).
- `BGP_NETWORKS_TO_DISTRIBUTE` — сети для анонса (`CIDR,RouteMap`).
- `BGP_RMAP_DEFAULT` — route-map по умолчанию для соседей и сетей.
- `BGP_ADJACENCY_LOG` — включает логирование сессий в FRR.
- `BGP_REDIST_CONNECTED` / `BGP_REDIST_STATIC` / `BGP_REDIST_KERNEL` — контроль перераспределения маршрутов.
- `FRR_ENABLE` — общий флаг включения пакета FRR в pfSense.
- `FRR_DEFAULT_ROUTER_ID` — router-id FRR при отсутствии BGP-настроек.
- `FRR_MASTER_PASSWORD` — пароль vtysh, можно использовать совместно с `FRR_PASSWORD_ENCRYPT` (`on` — хранить в зашифрованном виде).

## Пример файла `context.sh`
```sh
# Привязка интерфейсов по MAC-адресам
ETH0_MAC="00:50:56:aa:bb:01"
ETH0_TYPE="wan"
ETH0_IP="203.0.113.10"
ETH0_MASK="255.255.255.252"
ETH0_GATEWAY="203.0.113.9"
ETH0_DNS="8.8.8.8 1.1.1.1"

ETH1_MAC="00:50:56:aa:bb:02"
ETH1_TYPE="lan"
ETH1_IP="192.168.10.1"
ETH1_MASK="255.255.255.0"
ETH1_DNS="192.168.10.1"

SET_HOSTNAME="pfsense-demo"
PFCTL="off"
RC_RELOAD_ALL="on"
BLOCK_PRIVATE_NETWORKS="on"
BLOCK_BOGON_NETWORKS="off"
PASSWORD="SuperSecret123"
SSH_PUBLIC_KEY="ssh-ed25519 AAAAC3Nz... user@example"

# BGP и FRR
FRR_ENABLE="on"
FRR_DEFAULT_ROUTER_ID="192.0.2.1"
BGP_ENABLE="on"
BGP_AS="65001"
BGP_ROUTER_ID="192.0.2.1"
BGP_RMAP_DEFAULT="ALL"
BGP_NETWORKS_TO_DISTRIBUTE="192.168.10.0/24,ALL"
BGP_NEIGHBORS="198.51.100.2,65002,s3cr3t"
BGP_REDIST_CONNECTED="yes"
BGP_REDIST_STATIC="no"
```

### Журналы модулей

| Файл | Источник | Что фиксируется |
| --- | --- | --- |
| `/var/log/context.log` | `pfSense/etc/context.d/ContextOnly` и ранние хуки загрузки | Последовательность инициализации: монтирование ISO, настройка интерфейсов, DNS, обновление пароля, вызовы модулей.
| `/var/log/context-bgp.log` | `pfSense/etc/context.d/bgp` | Дамп переменных, проверка зависимостей FRR, ход инкрементального обновления соседей и сетей, ошибки применения через `vtysh`.
| `/var/log/context-firewall.log` | `pfSense/etc/context.d/firewall` (если модуль установлен) | Действия по генерации правил, предупреждения/ошибки, отчёт об изменённых правилах с префиксами `[INFO]`, `[WARN]`, `[ERROR]`, `[DEBUG]`.
| Пользовательский файл из переменной `LOG` | `pfSense/etc/context.d/ResizeZfs`, `pfSense/etc/context.d/pfctl_off` | Вывод о расширении ZFS и управлении pfctl; по умолчанию перенаправляется в `/dev/null`, при необходимости укажите путь для протоколирования.

### Практические советы

- Повторный запуск контекста вручную: `/etc/context.d/ContextOnly` (аналогично можно перезапустить `ResizeZfs`). Полезно после ручного редактирования `context.sh` без перезагрузки.
- Проверка установки пакетов: `pkg info xmlstarlet`, `pkg info pfSense-pkg-frr` или `pkg info frr9` помогают убедиться, что зависимые утилиты доступны.
- Если firewall отключён через `PFCTL=off`, убедитесь, что создан PID-файл `/var/run/pfctlcontext.pid` (его создание должно выполнять внешняя логика) — иначе cron-задача не будет вмешиваться.
- При расширении диска проверьте вывод `zpool list pfSense` и включите логирование `ResizeZfs`, чтобы убедиться, что zpool увеличен.

Соблюдение этих шагов обеспечивает корректное автоматическое конфигурирование pfSense в инфраструктуре OpenNebula, а README выступает в качестве справочника для администраторов.
