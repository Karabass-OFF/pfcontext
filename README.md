# pfcontext

## Назначение проекта
Автоматизация первичной настройки виртуальной машины pfSense, развёрнутой в OpenNebula. Скрипты читают файл `context.sh` из виртуального CD-ROM, и на основании переданных переменных обновляют `config.xml`, настраивают сетевые интерфейсы, службы pfSense и компоненты FRR/BGP. Это позволяет получить готовый к работе маршрутизатор сразу после первого запуска ВМ без ручного вмешательства.

## Структура репозитория
| Путь | Назначение |
| --- | --- |
| `pfSense/INSTALL` | Пошаговая инструкция по развёртыванию набора скриптов на узле pfSense: копирование файлов, установка зависимостей, применение патча к `/etc/rc.initial`, установка FRR и перезагрузка узла. |
| `pfSense/tmp/rc.initial.patch` | Патч, который добавляет в ранний этап загрузки вызов `ResizeZfs` и `ContextOnly`, а также файл состояния, чтобы избежать повторного запуска в пределах первых трёх минут работы системы. |
| `pfSense/etc/context.d/ContextOnly` | Основной модуль контекста. Монтирует CD-ROM, читает `context.sh`, применяет сетевые настройки, обновляет DNS, имя хоста, управляет перезагрузкой служб, паролем `admin`, вызывается модуль BGP и добавляет SSH-ключ.|
| `pfSense/etc/context.d/bgp` | Дополнительный модуль, который настраивает FRR/BGP на основе переменных контекста: собирает конфигурацию для `config.xml`, применяет её через PHP и `vtysh`, ведёт журнал и отслеживает изменения для инкрементального обновления.|
| `pfSense/etc/context.d/ResizeZfs` | Скрипт rc.d, который увеличивает ZFS-раздел/пул `pfSense`, если виртуальный диск был расширен, и записывает ход операций в журнал. |
| `pfSense/etc/context.d/pfctl_off` | Небольшой скрипт, который по PID-файлу решает, нужно ли периодически отключать pfctl (firewall) — вызывается из cron каждую минуту.|
| `pfSense/etc/devd/context.conf` | Правила `devd`, которые запускают `ContextOnly` при появлении CD-ROM с контекстом, `ResizeZfs` при изменении размера виртуального диска и помечают необходимость перепривязки сетей при добавлении/удалении интерфейсов. |
| `pfSense/etc/cron.d/context` | Планировщик, ежеминутно вызывающий `pfctl_off`, чтобы гарантировать выключение firewall при необходимости.|
| `pfSense/etc/phpshellsessions/ChangePassTool` | PHP-скрипт из pfSense для смены пароля пользователя `admin`, который используется модулем контекста при изменении переменной `PASSWORD`. |

## Последовательность выполнения и взаимосвязь модулей
1. **Загрузка pfSense и запуск ранних команд.** В `config.xml` прописывается `<earlyshellcmd>` с запуском `ResizeZfs` и `ContextOnly`, благодаря чему сценарии стартуют один раз на ранней стадии загрузки, минуя повторный запуск после первой минуты аптайма.
2. **Обработка аппаратных событий.** `devd` дополнительно вызывает `ContextOnly`, когда в систему вставляется ISO `CONTEXT`, и `ResizeZfs` при изменении размера диска, а также отмечает изменения сетевых интерфейсов в `/etc/context.d/net.pid`.
3. **Основной модуль ContextOnly.**
   - Монтирует CD-ROM `/dev/cd0` в `/mnt/context`, читает `context.sh`, делает резервную копию `config.xml` и подготавливает вспомогательную функцию `get_ctx_var` для чтения `ETHx_*` переменных.
   - Анализирует требуемые интерфейсы (MAC, типы), при необходимости очищает секцию `<interfaces>` в `config.xml`, сопоставляет MAC-адреса, назначает роли LAN/WAN/OPT, прописывает IP/маску/шлюз, отключает `blockpriv/bogons` на WAN и обновляет `config.xml`.
   - Собирает DNS-адреса, задаёт hostname, по опциям `RC_RELOAD_ALL`/`RC_RELOAD_IFACE` перезапускает службы/интерфейсы, управляет состоянием pfctl через `PFCTL`, обновляет пароль `admin`, размонтирует CD-ROM и запускает модуль BGP, если он доступен.
   - При наличии `SSH_PUBLIC_KEY` кодирует ключ в Base64 и записывает его в `config.xml` (секция пользователя `admin`), что обеспечивает доставку ключа при первой инициализации.
4. **Модуль BGP.** Запускается из `ContextOnly` и выполняет полную цепочку проверки зависимостей FRR, подгрузки `context.sh` при необходимости, генерации `config.xml` через PHP и применения настроек в рантайме через `vtysh`. Для предотвращения избыточных изменений хранит контрольные суммы и состояния сетей/соседей в `/var/run/context-bgp.*`.
5. **ResizeZfs.** Может запускаться как на старте, так и при событиях `devd`; расширяет ZFS-раздел и пул `pfSense`, если обнаружено свободное место и нет повреждений GPT.
6. **Периодический контроль firewall.** `cron` каждую минуту запускает `pfctl_off`, который отключает pfctl, если существует PID-файл `/var/run/pfctlcontext.pid`. Это позволяет оставлять firewall выключенным до завершения контекстной инициализации.
Первичный запуск теперь осуществляется штатным механизмом pfSense.

## Процесс установки
1. Скопируйте содержимое каталога `pfSense` на целевую систему (например, через `scp -r ./ root@pfSense:/`).
2. Установите зависимости:
   - `xmlstarlet` (команда `pkg install -y xmlstarlet`) — предоставляет утилиту `xml`, которой оперирует `ContextOnly` для редактирования `config.xml` и чтения текущих значений.
   - `php` CLI — уже входит в pfSense, но модуль BGP проверяет наличие `/usr/local/bin/php`; убедитесь, что пакет установлен.
   - `pfSense-pkg-frr` или `frr9` — обязательны для работы BGP-модуля; устанавливаются через `pkg install` (скрипт предлагает найти актуальный пакет командой `pkg search -x frr`).
3. Добавьте ранний запуск контекста. Откройте `config.xml` и в раздел `<system>` добавьте строку `<earlyshellcmd>/etc/context.d/ResizeZfs && /etc/context.d/ContextOnly </earlyshellcmd>` либо следуйте подсказкам из `pfSense/INSTALL`.
4. При необходимости очистите логи/бэкапы (опциональный шаг из исходной инструкции).
5. Перезагрузите устройство pfSense, чтобы запустился новый поток инициализации.

## Переменные контекста
Все переменные передаются через `context.sh`, который предоставляет OpenNebula. Скрипт поддерживает два семейства префиксов (`ETHx_*` и `ETHERNETx_*`) — они взаимозаменяемы. Ниже приведены основные группы.

### Сетевые параметры
| Переменная | Назначение |
| --- | --- |
| `ETHx_MAC` | MAC-адрес сетевого интерфейса, по которому скрипт сопоставляет физический порт с параметрами контекста.|
| `ETHx_TYPE` / `ETHERNETx_TYPE` | Требуемая роль интерфейса: `lan`, `wan` или `optN`. Определяет, в какой раздел `<interfaces>` будет помещён интерфейс и какие резервные имена (LAN/WAN/OPT) будут заняты. Переменная `ETHERNETx_TYPE` добавлена для совместимости с OpenNebula 7. |
| `ETHx_IP` | IPv4-адрес интерфейса. Используется совместно с `MASK` для настройки стека и записи в `config.xml`. |
| `ETHx_MASK` | Маска сети. Скрипт пересчитывает её в префикс (/CIDR) и сохраняет в `config.xml` и интерфейсной конфигурации.|
| `ETHx_GATEWAY` | Шлюз по умолчанию для данного интерфейса. Применяется только к WAN: создаёт маршрут по умолчанию и прописывает `WANGW` в `config.xml`. Фильтрация приватных/bogon-сетей настраивается отдельными флагами. |
| `ETHx_DNS` | Список DNS-адресов (принимает пробелы или несколько значений). Первый и последний элемент попадают в `/etc/resolv.conf` и `config.xml`, а также отключается `dnsallowoverride`. |

Дополнительно, если тип не указан, скрипт автоматически назначает `lan` для приватных сетей и `wan` для публичных, заполняя остальные интерфейсы последовательными `optN`.

### Сервисные параметры
| Переменная | Назначение |
| --- | --- |
| `PFCTL` | Управление состоянием firewall: значения `off`, `0`, `false`, `disabled` выключают pfctl; `on`, `1`, `true`, `enabled` включают (если был выключен). |
| `BLOCK_PRIVATE_NETWORKS` | Если `on`, оставляет включённой проверку private-сетей (`blockpriv`) на WAN; иначе опция удаляется из `config.xml`. |
| `BLOCK_BOGON_NETWORKS` | Если `on`, оставляет включённой проверку bogon-сетей (`blockbogons`) на WAN; иначе опция удаляется из `config.xml`. |
| `RC_RELOAD_ALL` | Если установлено в `on`, после сохранения `config.xml` запускается `/etc/rc.reload_all` и `pfSsh.php playback restartallwan` для полной перезагрузки сервисов. |
| `RC_RELOAD_IFACE` | При значении `on` инициирует перезапуск WAN-интерфейсов через `pfSsh.php playback restartallwan`. Полезно при обновлении адреса без полной перезагрузки сервисов. |
| `PASSWORD` | Новый пароль пользователя `admin`. Скрипт сравнивает его с текущим хэшем в `config.xml` и при отличии запускает `ChangePassTool`. |
| `SSH_PUBLIC_KEY` | Публичный ключ, добавляемый в профиль `admin`: значение кодируется в base64, сохраняется в `config.xml` и попадает в `/root/.ssh/authorized_keys` после применения конфигурации. При первом добавлении скрипт принудительно включает `RC_RELOAD_ALL`, чтобы pfSense перечитала конфигурацию и установила ключ. |
| `BGP_ENABLE` | Включение модуля BGP (значение `on`). Если параметр выключен или отсутствует, модуль завершается без изменений. |
| `BGP_AS`, `BGP_ROUTER_ID` | Номер автономной системы и router-id для BGP; обязательны при `BGP_ENABLE=on`. |
| `BGP_NEIGHBORS` | Список соседей через пробел/точку с запятой в формате `IP,ASN,password`. Используется для генерации записей `frrbgpneighbors` и конфигурации `vtysh`. Пароль может быть опущен. |
| `BGP_NETWORKS_TO_DISTRIBUTE` | Список сетей для анонса, формат `CIDR,RouteMap`. Если route-map не указан, берётся значение `BGP_RMAP_DEFAULT`. |
| `BGP_RMAP_DEFAULT` | Имя route-map по умолчанию. Создаётся секция `frrglobalroutemaps` и используется для соседей/сетей, если не задано иное. |
| `BGP_ADJACENCY_LOG`, `BGP_REDIST_CONNECTED`, `BGP_REDIST_STATIC`, `BGP_REDIST_KERNEL` | Управляют соответствующими флагами BGP (включение логирования сессий и перераспределение маршрутов). |
| `FRR_ENABLE`, `FRR_DEFAULT_ROUTER_ID`, `FRR_MASTER_PASSWORD`, `FRR_PASSWORD_ENCRYPT` | Глобальные настройки пакета FRR, отражаются в `installedpackages.frr`. Пароль может храниться в зашифрованном виде при `FRR_PASSWORD_ENCRYPT=on`. |

### Системные/служебные параметры
| Переменная | Назначение |
| --- | --- |
| `SET_HOSTNAME` | Имя хоста, которое записывается в систему и `config.xml`. |
| `RC_RELOAD_ALL` / `RC_RELOAD_IFACE` | Управление перезапуском служб/интерфейсов после изменения `config.xml`. |
| `CONTEXT`-переменные среды | Внутренние переменные (`CONTEXT_MOUNT`, `CONTEXT_DEV`, `PID`) управляют процессом монтирования ISO и отслеживанием изменений интерфейсов. Пользователю их задавать не нужно, но важно знать о лог-файле `/var/log/context.log`. |

## Пример файла `context.sh`
```sh
# Привязка интерфейсов по MAC-адресам
ETH0_MAC="00:50:56:aa:bb:01"
ETH0_TYPE="wan"
ETH0_IP="203.0.113.10"
ETH0_MASK="255.255.255.252"
ETH0_GATEWAY="203.0.113.9"
ETH0_DNS="8.8.8.8 1.1.1.1"

ETH1_MAC="00:50:56:aa:bb:02"
ETH1_TYPE="lan"
ETH1_IP="192.168.10.1"
ETH1_MASK="255.255.255.0"
ETH1_DNS="192.168.10.1"

SET_HOSTNAME="pfsense-demo"
PFCTL="off"
RC_RELOAD_ALL="on"
BLOCK_PRIVATE_NETWORKS="on"
BLOCK_BOGON_NETWORKS="off"
PASSWORD="SuperSecret123"
SSH_PUBLIC_KEY="ssh-ed25519 AAAAC3Nz... user@example"

# BGP и FRR
FRR_ENABLE="on"
FRR_DEFAULT_ROUTER_ID="192.0.2.1"
BGP_ENABLE="on"
BGP_AS="65001"
BGP_ROUTER_ID="192.0.2.1"
BGP_RMAP_DEFAULT="ALL"
BGP_NETWORKS_TO_DISTRIBUTE="192.168.10.0/24,ALL"
BGP_NEIGHBORS="198.51.100.2,65002,s3cr3t"
BGP_REDIST_CONNECTED="yes"
BGP_REDIST_STATIC="no"
```

## Отладка и эксплуатационные заметки
- Основной журнал инициализации: `/var/log/context.log`. Здесь фиксируется ход работы `ContextOnly`, включая монтирование ISO, настройку интерфейсов, DNS, изменение пароля, выполнение BGP-модуля и т.д.
- Журнал BGP: `/var/log/context-bgp.log`, создаётся модулем `bgp` и содержит подробности применения FRR-конфигурации.
- Повторный запуск контекста вручную: `/etc/context.d/ContextOnly ` (аналогично можно перезапустить `ResizeZfs`). Полезно после ручного редактирования `context.sh` без перезагрузки.
- Проверка установки пакетов: `pkg info xmlstarlet`, `pkg info pfSense-pkg-frr` или `pkg info frr9` помогают убедиться, что зависимые утилиты доступны.
- Если firewall отключён через `PFCTL=off`, убедитесь, что создан PID-файл `/var/run/pfctlcontext.pid` (его создание должно выполнять внешняя логика) — иначе cron-задача не будет вмешиваться.
- При расширении диска проверьте вывод `zpool list pfSense` и логи `ResizeZfs`, чтобы убедиться, что zpool увеличен.

Соблюдение этих шагов обеспечивает корректное автоматическое конфигурирование pfSense в инфраструктуре OpenNebula, а README выступает в качестве справочника для администраторов.
